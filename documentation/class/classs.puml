@startuml

left to right direction
!pragma layout smetana

'skinparam linetype ortho
'skinparam linetype polyline

    legend top left
        <b>3. Class.</b> Имплементационная перспектива
        ----
        Version: 0.2.2
        Date: 02/12/25
    '    -- Автор --
    '    Pavel Isaenko
        -- Обозначения --
        — Бизнес-логика и сущности обозначены в разделе "Business"
        — JpaRepository обозначены для удобства. Они уже определены в Spring JPA
    end legend

rectangle "Business" {
    entity User {
            - String name
            - String login
            - Role role
            - String passwordHash
            - LocalDateTime createdAt
            - LocalDateTime changedAt

            + void updateChangingDate()
    }

    record Goal {
        - String goalName
        - Integer goalValue
    }

    enum Role {
        - String name
        - String description
    }

    class CampaignToReportTemplate {
        - Campaign campaign
        - ReportTemplate reportTemplate
    }

    entity ReportTemplate {
        - String name
        - Set<CampaignToReportTemplate> reportTemplatesSet
        - Client client
        - List<Report> reportsList
        - int frequency
        - User createdBy
        - ZonedDateTime createdAt
        - User changedBy
        - ZonedDateTime changedAt
        - boolean isActive
        - String dashboardURL

        + void updateName(String newName)
        + void addCampaign(Campaign newCampaign)
        + void deleteCampaign(Campaign campaign)
        + void activate()
        + void deactivate()
    }
    note right of ReportTemplate::frequency
        Нужна Quartz-реализация
    end note
    entity Report {
        - ReportTemplate reportTemplate
        - int impressions
        - int clicks
        - int ctr
        - int avgClickPrice
        - int cancels
        - int conversionPrice
        - int conversionCoef
        - List<Goal> goals
        - ZonedDateTime createdAt
    }

    entity Client {
        - String name
        - String yaDirectLogin
        - List<Campaign> campaignsList
    }

    entity Campaign {
        - String name
        - Client client
        - String deviceType
        - String platform
        - Set<CampaignToReportTemplate> campaignsSet
    }
}

rectangle "Users"{
    interface JpaRepository<User, Integer> <<external>>
    interface UserRepository extends JpaRepository<User, Integer>{
    }

    JpaRepository ..> User
    UserService --> UserRepository
    UserService ..> User

    class UserService{
            - UserRepository userRepository

            + List<User> getAllUsers()
            + User getUserById()
            + void createNewUser(String name, String login, String role, String password)
            + void deleteUser(User user)
    }
}

rectangle "Campaigns" {
    interface JpaRepository<Campaign, Integer> <<external>>
    interface CampaignRepository extends JpaRepository<Campaign, Integer> {

    }
    JpaRepository ..> Campaign
    CampaignService --> CampaignRepository

    class CampaignService {
        - CampaignRepository campaignRepository
    }
}

rectangle "Reports" {
    interface JpaRepository<Report, Integer> <<external>>
    interface ReportRepository extends JpaRepository<Report, Integer> {
    }
    JpaRepository ..> Report
    ReportService --> ReportRepository

    class ReportService {

    }
}

rectangle "ReportTemplates" {
    interface JpaRepository<ReportTemplate, Integer> <<external>>
    interface ReportTemplateRepository extends JpaRepository<ReportTemplate, Integer>{
    }
    JpaRepository ..> ReportTemplate
    ReportTemplateService --> ReportTemplateRepository

    class ReportTemplateService {

    }
}

rectangle "Clients" {
    interface JpaRepository<Client, Integer> <<external>>
    interface ClientRepository extends JpaRepository<Client, Integer> {
    }
    JpaRepository ..> Client
    ClientService --> ClientRepository

    class ClientService {
    }
}

rectangle "CampaignsToReportTemplates" {
    interface JpaRepository<CampaignsToReportTemplate, Integer> <<external>>
    interface CampaignToReportTemplateRepository implements JpaRepository<CampaignToReportTemplate, Integer> {
    }
    JpaRepository ..> CampaignToReportTemplate
    CampaignToReportTemplateService --> CampaignToReportTemplateRepository

    class CampaignToReportTemplateService {
    }
}

class MainPageController {
    - UserService

    + addUserToModel()
    + showPage()
}

class UsersPageController {
    - UserService userService
    + addUserToModel(Model)
    + showPage()
}

User "*" --> "1" Role : role
ReportTemplate "*" --> "1" User : createdBy
ReportTemplate "*" --> "1" User : changedBy
'ReportTemplate "*" -- "*" Campaign
ReportTemplate "1" -- "*" CampaignToReportTemplate : reportTemplatesSet
CampaignToReportTemplate "*" -- "1" Campaign : campaignsSet
ReportTemplate "*" -- "1" Client : client
ReportTemplate "1" -- "*" Report : reportTemplate
Client "1" -- "*" Campaign : client
Report "1" -- "*" Goal : goals


UsersPageController --> UserService
MainPageController --> UserService

@enduml
